# Турникет на Arduino UNO

## Описание проекта

Система турникета с RFID-авторизацией, управляемая Arduino UNO, включает в себя:
- Дисплей TFT 2.8" ILI9341 (через микросхему 74HC595)
- Два RFID модуля MFRC522
- Ультразвуковой дальномер HC-SR04
- Сервопривод для управления дверью
- SD карту для хранения разрешенных ID карт

## Архитектура проекта

Проект организован с использованием объектно-ориентированного подхода. Все классы находятся в папке `src`:

### Классы компонентов:

1. **RFIDReader** (`RFIDReader.h/.cpp`)
   - Управление одним RFID модулем RC522
   - Чтение ID карт
   - Методы: `init()`, `isCardPresent()`, `readCardID()`, `stopReading()`

2. **Display** (`Display.h/.cpp`)
   - Управление дисплеем TFT
   - Отображение различных сообщений
   - Методы: `init()`, `showWaitingMessage()`, `showWelcomeMessage()`, `showGoodbyeMessage()`, `showAccessDeniedMessage()`, `showNoPassageMessage()`

3. **DoorController** (`DoorController.h/.cpp`)
   - Управление сервоприводом (дверью)
   - Позиции: закрыто (90°), открыто для входа (0°), открыто для выхода (180°)
   - Методы: `init()`, `openForEntry()`, `openForExit()`, `closeDoor()`

4. **DistanceSensor** (`DistanceSensor.h/.cpp`)
   - Управление ультразвуковым дальномером HC-SR04
   - Измерение расстояния
   - Калибровка базового расстояния
   - Методы: `init()`, `measureDistance()`, `calibrate()`

5. **IDStorage** (`IDStorage.h/.cpp`)
   - Работа с SD картой
   - Чтение файла с разрешенными ID
   - Проверка карт на доступ
   - Методы: `init()`, `isIDAllowed()`

### Основной класс:

6. **Turnstile** (`Turnstile.h/.cpp`)
   - Координация работы всех компонентов
   - Управление состояниями системы
   - Реализация логики прохода
   - Методы: `init()`, `loop()`

## Подключение устройств

### Пины:

- **TFT LCD** (через 74HC595): CS=A3, CD=A2, WR=A1, RST=A4
- **RFID Entry**: SS=2, RST=3
- **RFID Exit**: SS=4, RST=5
- **Дальномер**: TRIG=6, ECHO=7
- **Сервопривод**: A5
- **SD карта**: CS=10

### SPI подключается к:
- RFID модули используют SPI для связи

## Формат файла ID на SD карте

Файл `ids.data` на SD карте содержит разрешенные ID карт в следующем формате:

```
[Размер байт ID] + [Байты ID] + [Размер байт следующего ID] + [Байты следующего ID] + ...
```

Например, для ID карты с байтами `0x12 0x34 0x56 0x78`:
- Первый байт: `0x04` (размер ID - 4 байта)
- Следующие 4 байта: `0x12 0x34 0x56 0x78`

Записи в файле идут подряд без разделителей.

## Алгоритм работы турникета

1. **Режим ожидания**:
   - На экране отображается сообщение "Приложите карту" на голубом фоне
   - Дверь закрыта (90 градусов)

2. **При прикладывании карты** (вход/выход):
   - Чтение ID карты
   - Проверка ID в файле `ids.data`
   
3. **Если ID разрешен**:
   - Открытие двери (0° для входа, 180° для выхода)
   - Показ сообщения "Добро пожаловать" или "До свидания"
   - Запуск таймера на 15 секунд для прохода
   
4. **Детектирование прохода**:
   - Дальномер измеряет расстояние каждые 10 мс
   - Если расстояние уменьшилось (< 95% базового), регистрируется проход
   - Таймер на 1 сек сбрасывается при каждом новом снижении расстояния
   
5. **После прохода**:
   - Таймер на 5 сек для закрытия двери
   - Автоматическое возвращение в режим ожидания

6. **Если проход не зарегистрирован за 15 сек**:
   - Показ сообщения "Проход не был осуществлен" на желтом фоне
   - Закрытие двери через 5 сек
   - Возврат в режим ожидания

7. **Если ID не разрешен**:
   - Показ сообщения "Проход запрещен" на красном фоне
   - Возврат в режим ожидания через 5 сек

## Использованные библиотеки

- `Adafruit_GFX` - графика для TFT
- `Adafruit_TFTLCD` - управление TFT дисплеем
- `MFRC522` - работа с RFID модулями
- `Servo` - управление сервоприводом
- `SD` - работа с SD картой
- `SPI` - SPI интерфейс для RFID

## Установка и компиляция

1. Убедитесь, что все необходимые библиотеки установлены в Arduino IDE
2. Откройте файл `src/main/main.ino` в Arduino IDE
3. Проверьте подключения всех компонентов согласно схеме
4. Создайте файл `ids.data` на SD карте с разрешенными ID
5. Загрузите скетч на Arduino UNO

## Примечания

- Дисплей должен быть подключен через микросхему 74HC595 (код для этого уже отредактирован пользователем)
- Поддерживается только латинская кодировка для отображения текста (русские буквы будут отображаться неправильно на стандартном дисплее)
- Для корректной работы дальномера необходимо правильно настроить базовое расстояние при калибровке
- SD карта должна быть отформатирована в FAT16 или FAT32

